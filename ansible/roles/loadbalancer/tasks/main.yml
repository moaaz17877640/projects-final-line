---
# Load Balancer Role - Main Tasks
- name: Install Nginx
  apt:
    name: nginx
    state: present
    update_cache: yes

# SSL/Let's Encrypt Setup
- name: Install Certbot and Nginx plugin
  apt:
    name:
      - certbot
      - python3-certbot-nginx
    state: present
  when: enable_ssl | default(false)

- name: Check if SSL certificate exists
  stat:
    path: "/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem"
  register: ssl_cert_exists
  when: enable_ssl | default(false)

- name: Create initial Nginx configuration (HTTP only for Certbot)
  template:
    src: nginx-site.conf.j2
    dest: /etc/nginx/sites-available/employee-app
    mode: '0644'
  vars:
    enable_ssl: false
  when: enable_ssl | default(false) and not ssl_cert_exists.stat.exists | default(false)

- name: Enable employee-app site (initial)
  file:
    src: /etc/nginx/sites-available/employee-app
    dest: /etc/nginx/sites-enabled/employee-app
    state: link
  when: enable_ssl | default(false) and not ssl_cert_exists.stat.exists | default(false)

- name: Remove default Nginx site (before certbot)
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent

- name: Reload Nginx for Certbot
  systemd:
    name: nginx
    state: reloaded
  when: enable_ssl | default(false) and not ssl_cert_exists.stat.exists | default(false)

- name: Obtain Let's Encrypt SSL certificate
  command: >
    certbot certonly --nginx
    -d {{ domain_name }}
    --email {{ ssl_email }}
    --agree-tos
    --non-interactive
    --redirect
  args:
    creates: "/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem"
  when: enable_ssl | default(false) and not ssl_cert_exists.stat.exists | default(false)
  register: certbot_result
  ignore_errors: yes

- name: Display Certbot result
  debug:
    msg: "{{ certbot_result.stdout_lines | default(['Certbot completed']) }}"
  when: enable_ssl | default(false) and certbot_result is defined

- name: Setup automatic certificate renewal
  cron:
    name: "Certbot auto-renewal"
    minute: "0"
    hour: "3"
    job: "certbot renew --quiet --post-hook 'systemctl reload nginx'"
  when: enable_ssl | default(false)

# Final Nginx Configuration
- name: Create Nginx configuration
  template:
    src: nginx-site.conf.j2
    dest: /etc/nginx/sites-available/employee-app
    mode: '0644'
  notify: restart nginx

- name: Enable employee-app site
  file:
    src: /etc/nginx/sites-available/employee-app
    dest: /etc/nginx/sites-enabled/employee-app
    state: link
  notify: restart nginx

- name: Remove default Nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: restart nginx

- name: Create health check script
  template:
    src: health-check.sh.j2
    dest: /usr/local/bin/health-check.sh
    mode: '0755'

- name: Setup health check cron job
  cron:
    name: "Health check monitoring"
    minute: "*/{{ health_check_interval }}"
    job: "/usr/local/bin/health-check.sh"

- name: Create enhanced monitoring script
  template:
    src: enhanced-monitor.sh.j2
    dest: /usr/local/bin/enhanced-monitor.sh
    mode: '0755'

- name: Setup enhanced monitoring cron job
  cron:
    name: "Enhanced health monitoring"
    minute: "*/10"
    job: "/usr/local/bin/enhanced-monitor.sh"
    user: root

- name: Create log rotation for health checks
  template:
    src: nginx-health-logrotate.j2
    dest: /etc/logrotate.d/nginx-health
    mode: '0644'

- name: Start and enable Nginx
  systemd:
    name: nginx
    enabled: yes
    state: started

- name: Wait for Nginx to be ready
  wait_for:
    port: 80
    host: "{{ ansible_default_ipv4.address }}"
    delay: 5
    timeout: 30

- name: Verify frontend deployment
  uri:
    url: "http://{{ ansible_host }}/"
    method: GET
    status_code: 200
  register: frontend_check
  retries: 3
  delay: 10

- name: Check if backends are reachable (non-blocking)
  uri:
    url: "http://{{ ansible_host }}/api/employees"
    method: GET
    status_code: 200
    timeout: 10
  register: api_check
  retries: 2
  delay: 5
  ignore_errors: yes
  
- name: Log API verification result
  debug:
    msg: "API Verification: {{ 'SUCCESS - Backends are running' if api_check is defined and not api_check.failed else 'SKIPPED - Backend not deployed yet (run backend pipeline first)' }}"

- name: Wait for nginx to stabilize
  pause:
    seconds: 5


- name: Display deployment info
  debug:
    msg: |
      ðŸŽ‰ LOAD BALANCER DEPLOYMENT COMPLETE! ðŸŽ‰
      =======================================
      Website URL: {{ 'https://' + (domain_name | default(ansible_host)) if enable_ssl | default(false) else 'http://' + (ansible_host | string) }}
      API Endpoints: {{ 'https://' + (domain_name | default(ansible_host)) if enable_ssl | default(false) else 'http://' + (ansible_host | string) }}/api/employees
      Health Check: {{ 'https://' + (domain_name | default(ansible_host)) if enable_ssl | default(false) else 'http://' + (ansible_host | string) }}/health
      SSL Status: {% if enable_ssl | default(false) %}Enabled (Let's Encrypt){% else %}Disabled (HTTP Only){% endif %}
      Domain: {{ domain_name | default('N/A (using IP)') }}
      Frontend Status: {{ 'SUCCESS' if frontend_check is defined and frontend_check.status == 200 else 'FAILED' }}
      API Status: {{ 'SUCCESS' if api_check is defined and not api_check.failed else 'PENDING - Run backend pipeline' }}
      Backend Servers: Multiple backend servers on port {{ app_port | default('8080') }}
      Health Monitoring: Every {{ health_check_interval | default('30') }} minutes
      =======================================