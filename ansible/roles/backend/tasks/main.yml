---
# Backend Role - Main Tasks
- name: Install Java 17 and MySQL
  apt:
    name: 
      - openjdk-17-jdk
      - mysql-server
      - build-essential
    state: present
    update_cache: yes

- name: Start and enable MySQL
  systemd:
    name: mysql
    state: started
    enabled: yes

- name: Setup MySQL database
  shell: |
    # Wait for MySQL to be ready
    timeout 30 bash -c 'until mysql -u root -e "SELECT 1;" &> /dev/null; do sleep 1; done'
    mysql -u root -e "CREATE DATABASE IF NOT EXISTS {{ mysql_database }};"
    mysql -u root -e "CREATE USER IF NOT EXISTS '{{ mysql_user }}'@'localhost' IDENTIFIED WITH mysql_native_password BY '{{ mysql_password }}';"
    mysql -u root -e "GRANT ALL PRIVILEGES ON {{ mysql_database }}.* TO '{{ mysql_user }}'@'localhost';"
    mysql -u root -e "FLUSH PRIVILEGES;"
  ignore_errors: yes
  retries: 3
  delay: 5

- name: Create application directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop:
    - /opt/employee-management
    - /var/log/employee-management

- name: Remove existing source directory
  file:
    path: /opt/employee-management-src
    state: absent

- name: Copy pre-built JAR file from Jenkins workspace
  copy:
    src: "{{ playbook_dir }}/../backend/target/employee-management-app-0.0.1-SNAPSHOT.jar"
    dest: /opt/employee-management/employee-management-app.jar
    mode: '0755'
    owner: root
    group: root

- name: Create application configuration
  template:
    src: application.properties.j2
    dest: /opt/employee-management/application.properties
    mode: '0644'
  notify: restart backend service

- name: Create backend systemd service
  template:
    src: employee-backend.service.j2
    dest: /etc/systemd/system/employee-backend.service
    mode: '0644'
  notify:
    - reload systemd
    - restart backend service

- name: Setup log rotation
  template:
    src: logrotate.j2
    dest: /etc/logrotate.d/employee-management
    mode: '0644'

- name: Change log directory ownership
  file:
    path: /var/log/employee-management
    owner: root
    group: root
    mode: '0755'
    recurse: yes

- name: Start and enable backend service
  systemd:
    name: employee-backend
    enabled: yes
    state: started
    daemon_reload: yes

- name: Wait for backend service to be ready
  wait_for:
    port: "{{ app_port }}"
    host: localhost
    delay: 10
    timeout: 120
  ignore_errors: yes
  
- name: Verify backend API health
  uri:
    url: "http://localhost:{{ app_port }}/api/employees"
    method: GET
    status_code: 200
    timeout: 30
  register: backend_health
  retries: 10
  delay: 10
  ignore_errors: yes