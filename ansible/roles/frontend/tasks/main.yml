---
# Frontend Role - Deploy pre-built React files
# The React build is done on Jenkins (fast), then files are copied to the server

- name: Create web directory
  file:
    path: /var/www/html
    state: directory
    mode: '0755'
    owner: www-data
    group: www-data

- name: Clean existing frontend files
  shell: rm -rf /var/www/html/*

- name: Archive frontend build locally
  shell: cd "{{ playbook_dir }}/../frontend/build" && zip -r "{{ playbook_dir }}/../frontend/frontend_build.zip" .
  delegate_to: localhost
  run_once: true

- name: Copy frontend archive to server
  copy:
    src: "{{ playbook_dir }}/../frontend/frontend_build.zip"
    dest: /tmp/frontend_build.zip
    mode: '0644'

- name: Extract frontend archive
  unarchive:
    src: /tmp/frontend_build.zip
    dest: /var/www/html/
    remote_src: yes
    owner: www-data
    group: www-data
    mode: '0755'

- name: Cleanup local archive
  file:
    path: "{{ playbook_dir }}/../frontend/frontend_build.zip"
    state: absent
  delegate_to: localhost
  run_once: true


- name: Verify frontend files exist
  stat:
    path: /var/www/html/index.html
  register: frontend_files

- name: Debug frontend deployment status
  debug:
    msg: "Frontend files deployed: {{ frontend_files.stat.exists | default(false) }}"

- name: Fail if frontend files not deployed
  fail:
    msg: "Frontend files were not deployed correctly!"
  when: not frontend_files.stat.exists | default(false)
